name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install pyinstaller

    - name: Build Linux executable
      run: |
        pyinstaller --onefile --name repak-gui repak_gui.py

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-executable
        path: dist/repak-gui

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if (Test-Path requirements.txt) { pip install -r requirements.txt }
        pip install pyinstaller

    - name: Build Windows executable
      run: |
        pyinstaller --onefile --windowed --name repak-gui repak_gui.py

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: dist/repak-gui.exe

  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - uses: actions/checkout@v4

    - name: Download Linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: linux-executable
        path: dist/linux

    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-executable
        path: dist/windows

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/linux/repak-gui
          dist/windows/repak-gui.exe
        body: |
          # Repak GUI v1.1.0 - Major Update! ğŸ‰

          A professional GUI wrapper for repak, designed for STALKER 2 modding.

          ## ğŸ†• What's New in v1.1.0

          ### User Experience
          - âœ¨ **Keyboard Shortcuts** - Ctrl+O, Ctrl+E, Ctrl+L, Ctrl+Q, Escape
          - ğŸ“‹ **Recent Files** - Quick access to your last 10 PAK files
          - ğŸ›‘ **Cancel Operations** - Stop long-running tasks anytime
          - ğŸ–±ï¸ **Context Menus** - Right-click batch list for options
          - ğŸ’¾ **Configuration Persistence** - Window size and preferences saved

          ### Advanced Features
          - ğŸ“ **File Logging** - All operations logged to `repak_gui.log`
          - ğŸ“¤ **Export Logs** - Save logs for troubleshooting
          - ğŸ”’ **Enhanced Security** - Path validation, AES key redaction
          - âš¡ **Better Performance** - Optimized file operations

          ### Developer Improvements
          - ğŸ” **Type Hints** - Full type annotations
          - ğŸ§ª **Unit Tests** - Comprehensive test coverage
          - ğŸ“š **Documentation** - Professional README and CHANGELOG

          ## ğŸ“¥ Downloads

          ### Windows
          **[repak-gui.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/repak-gui.exe)**
          - Download and run directly
          - Includes all dependencies

          ### Linux
          **[repak-gui](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/repak-gui)**
          - Download, make executable: `chmod +x repak-gui`
          - Run: `./repak-gui`

          ## ğŸ“– Quick Start

          1. Download the appropriate version for your OS
          2. Run the application
          3. Use the **Unpack** tab to extract PAK files
          4. Use the **Pack** tab to create your own PAKs
          5. Use **Batch Unpack** for multiple files

          ## âŒ¨ï¸ Keyboard Shortcuts

          - `Ctrl+O` - Browse for PAK file
          - `Ctrl+L` - Clear log
          - `Ctrl+E` - Export log
          - `Ctrl+Q` - Quit
          - `Escape` - Cancel operation

          ## ğŸ“ Full Changelog

          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for complete version history.

          ## ğŸ› Issues?

          Report bugs at: https://github.com/${{ github.repository }}/issues

          ---

          ğŸ¤– **Built automatically with GitHub Actions**

          **Note**: You also need the `repak` binary in the same directory as this executable.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
